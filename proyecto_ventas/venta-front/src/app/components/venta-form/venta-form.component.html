<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-card">
                <div class="form-header">
                    <h2 class="fw-bold text-primary">Nueva Transacción de Venta</h2>
                    <p class="text-muted">Complete los datos para registrar la operación en el sistema</p>
                </div>

                <form [formGroup]="ventaForm">
                    <div class="row g-4">
                        <!-- Left Column: Header Info -->
                        <div class="col-md-4">
                            <div class="mb-3 position-relative">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="idCliente" class="form-label mb-0">Cliente Responsable</label>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-primary border-0 x-small fw-bold"
                                        (click)="registrarNuevoCliente()">
                                        <i class="bi bi-person-plus-fill"></i> Registrar
                                    </button>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="bi bi-search text-muted"></i>
                                    </span>
                                    <input type="text" id="idCliente" class="form-control border-start-0 ps-0"
                                        [(ngModel)]="searchTermCliente" [ngModelOptions]="{standalone: true}"
                                        (input)="onSearchCliente()" placeholder="Buscar por nombre o DNI...">
                                </div>

                                <!-- Search Results Dropdown -->
                                <div class="search-results-dropdown shadow-lg"
                                    *ngIf="mostrarResultadosCliente && clientesFiltrados.length > 0">
                                    <div class="search-item" *ngFor="let cliente of clientesFiltrados"
                                        (click)="seleccionarCliente(cliente)">
                                        <div class="fw-bold">{{cliente.nombre}} {{cliente.apellido}}</div>
                                        <div class="small text-muted">DNI: {{cliente.dni}}</div>
                                    </div>
                                </div>
                                <div class="search-results-dropdown p-3 text-center text-muted"
                                    *ngIf="mostrarResultadosCliente && clientesFiltrados.length === 0 && searchTermCliente">
                                    No se encontraron clientes.
                                </div>

                                <!-- Hidden control for form validation -->
                                <input type="hidden" formControlName="id_cliente">
                            </div>

                            <div class="mb-3">
                                <label for="idUsuario" class="form-label">Vendedor Asignado</label>
                                <select id="idUsuario" class="form-select" formControlName="id_usuario">
                                    <option value="">Seleccione un vendedor</option>
                                    <option *ngFor="let usuario of usuarios" [value]="usuario.id_usuario">
                                        {{usuario.nombre}}
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="idPago" class="form-label">Método de Pago</label>
                                <select id="idPago" class="form-select" formControlName="id_pago">
                                    <option value="">Seleccione un método</option>
                                    <option *ngFor="let metodoPago of metodosPago" [value]="metodoPago.id_pago">
                                        {{metodoPago.nombre}}
                                    </option>
                                </select>
                            </div>

                            <div class="p-3 bg-light rounded-4 text-center mt-4">
                                <p class="form-label d-block m-0">Monto Total</p>
                                <span class="total-badge">$ {{ventaForm.get('total')?.value | number:'1.2-2'}}</span>
                            </div>
                        </div>

                        <!-- Right Column: Details Info -->
                        <div class="col-md-8">
                            <div class="details-section">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="fw-bold m-0">Detalles del Pedido</h5>
                                    <button type="button" class="btn-add" (click)="agregarDetalle()">
                                        <span>+</span> Agregar Producto
                                    </button>
                                </div>

                                <div formArrayName="detalles">
                                    <div *ngFor="let detalle of detalles.controls; let i=index" [formGroupName]="i"
                                        class="detail-row">
                                        <div class="row g-2 align-items-end">
                                            <div class="col-md-6">
                                                <label [for]="'producto-' + i" class="form-label small">Producto</label>
                                                <select [id]="'producto-' + i" class="form-select"
                                                    formControlName="id_producto" (change)="onProductoChange(i)">
                                                    <option value="">Seleccione producto</option>
                                                    <option *ngFor="let producto of productos"
                                                        [value]="producto.id_producto">
                                                        {{producto.nombre}}
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label [for]="'cantidad-' + i" class="form-label small">Cantidad</label>
                                                <input [id]="'cantidad-' + i" type="number" class="form-control"
                                                    formControlName="cantidad" (change)="onCantidadChange(i)" min="1">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">Precio</label>
                                                <input type="text" class="form-control"
                                                    [value]="detalle.get('precio_unitario')?.value | number:'1.2-2'"
                                                    readonly aria-label="Precio unitario">
                                            </div>
                                            <div class="col-md-1 text-end">
                                                <button type="button" class="btn-remove" (click)="eliminarDetalle(i)"
                                                    aria-label="Eliminar producto">
                                                    &times;
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div *ngIf="detalles.length === 0"
                                        class="text-center py-4 text-muted border-dashed rounded-3">
                                        No hay productos agregados a esta venta.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 d-flex gap-3 justify-content-end">
                        <button type="button" class="btn btn-link text-secondary text-decoration-none fw-semibold"
                            (click)="cancelar()">
                            Cancelar
                        </button>
                        <button type="button" class="btn-submit" (click)="onSubmit()"
                            [disabled]="ventaForm.invalid || detalles.length === 0">
                            Confirmar y Registrar Venta
                        </button>
                    </div>

                    <!-- Alerts -->
                    <div class="mt-4">
                        <div class="alert alert-success border-0 shadow-sm rounded-4" *ngIf="successMessage"
                            role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i> {{successMessage}}
                        </div>
                        <div class="alert alert-danger border-0 shadow-sm rounded-4" *ngIf="error" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> {{error}}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>